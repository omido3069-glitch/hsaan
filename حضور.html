<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø°ÙƒÙŠ - Ø¬Ø§Ù…Ø¹Ø© Ø­Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #0f172a;
            --accent: #f59e0b; 
            --main-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --gold: #fbbf24;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: 0.3s; }

        body { 
            background: var(--main-gradient); 
            background-attachment: fixed; min-height: 100vh;
            margin: 0; padding: 20px; color: #f1f5f9; position: relative;
        }

        .logo-left, .logo-right { position: absolute; top: 20px; z-index: 1000; }
        .logo-left { left: 30px; } .logo-right { right: 30px; }
        .logo-left img, .logo-right img {
            width: 100px; height: 100px; border-radius: 50%;
            border: 3px solid var(--gold); background: white;
            box-shadow: 0 0 20px rgba(245,158,11,0.4);
        }

        .container { max-width: 1100px; margin: auto; padding-top: 20px; }

        @keyframes slowGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .header { text-align: center; margin-bottom: 30px; margin-top: 40px; }
        .header h1, .header p {
            display: block; width: fit-content; margin: 8px auto;
            background: linear-gradient(270deg, #f59e0b, #fbbf24, #ffffff, #fbbf24, #f59e0b);
            background-size: 400% 400%; -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; animation: slowGradient 15s ease infinite;
            font-weight: 800; text-shadow: 2px 2px 10px rgba(0,0,0,0.2);
        }

        .attendance-card {
            background: #ffffff; border-radius: 20px; padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-bottom: 30px; color: #1e293b;
            text-align: center;
        }

        .live-clock {
            font-size: 2.8rem; font-weight: 800; color: var(--primary);
            margin-bottom: 20px; border-bottom: 3px solid var(--accent);
            display: inline-block; padding: 0 30px;
        }

        .select-box {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 2px solid #e2e8f0; font-size: 1.1rem; font-weight: 700;
            margin-bottom: 25px; outline: none; background: #f8fafc;
        }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .btn-action {
            padding: 20px; border: none; border-radius: 12px;
            font-weight: 800; font-size: 1.3rem; cursor: pointer; color: white;
        }
        .in { background: #10b981; } .out { background: #ef4444; }

        .controls-row {
            display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; margin-bottom: 25px;
        }
        .search-box, .date-filter {
            background: white; padding: 15px; border-radius: 15px;
            display: flex; align-items: center; gap: 10px; border: 3px solid var(--accent); color: var(--primary);
        }
        .search-box input, .date-filter input {
            flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-weight: bold; font-family: 'Cairo';
        }

        .log-section { background: white; border-radius: 20px; padding: 20px; color: #1e293b; overflow: hidden; }
        .log-table { width: 100%; border-collapse: collapse; }
        .log-table th { background: var(--primary); color: white; padding: 18px; font-size: 1.2rem; }
        
        .log-table td { 
            padding: 15px; text-align: center; 
            border-bottom: 1px solid #f1f5f9; 
            font-weight: 800; font-size: 1.25rem; color: #000000; 
        }

        .date-separator {
            background: #f8fafc !important; font-weight: 800 !important;
            color: var(--primary); text-align: center !important;
            padding: 12px !important; font-size: 1.3rem;
            border-top: 2px solid var(--accent); border-bottom: 2px solid var(--accent);
        }

        .edit-btn { background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; color: #64748b; font-size: 1.1rem; }
        .edit-btn:hover { background: #cbd5e1; color: #000; }
    </style>
</head>
<body>

<div class="logo-left"><img src="1.png"></div>
<div class="logo-right"><img src="123.png"></div>

<div class="container">
    <div class="header">
        <h1>Ø¬Ø§Ù…Ø¹Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ø© Ø­Ù„Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€ÙˆØ§Ù† Ø§Ù„Ø§Ù‡Ù„ÙŠÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ø©</h1>
        <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¥Ù†ØµØ±Ø§Ù Ø§Ù„Ø°ÙƒÙŠ</p>
    </div>

    <div class="attendance-card">
        <div class="live-clock" id="clock">00:00</div>
        <select id="workerSelect" class="select-box">
            <option value="">-- ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„... --</option>
        </select>
        <div class="btn-group">
            <button class="btn-action in" onclick="markAttendance('check_in')">ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± ğŸŸ¢</button>
            <button class="btn-action out" onclick="markAttendance('check_out')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù†ØµØ±Ø§Ù ğŸ”´</button>
        </div>
    </div>

    <div class="controls-row">
        <div class="search-box">
            <label>ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹:</label>
            <input type="text" id="workerSearchInput" onkeyup="filterAttendanceTable()" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„...">
        </div>
        <div class="date-filter">
            <label>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="historyDate" onchange="fetchLogs()">
            <button onclick="resetToToday()" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:bold;">Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
    </div>

    <div class="log-section">
        <table class="log-table">
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
                    <th>ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                    <th>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="attendanceLogs"></tbody>
        </table>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://jkvjopwfrdkpzmcjrqbo.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprdmpvcHdmcmRrcHptY2pycWJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzODA5NTksImV4cCI6MjA4MDk1Njk1OX0.P371b8Y3fovadr0l5LO-o-iL9cBoWIo3py6LgUxHeek';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    }, 1000);
    document.getElementById('historyDate').valueAsDate = new Date();

    async function loadWorkers() {
        const { data } = await _supabase.from('permits').select('name, nid');
        const select = document.getElementById('workerSelect');
        if (data) {
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ù…Ù„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© --</option>';
            data.forEach(w => { select.innerHTML += `<option value="${w.name}" data-nid="${w.nid}">${w.name}</option>`; });
        }
    }

    async function markAttendance(type) {
        const select = document.getElementById('workerSelect');
        const name = select.value;
        if (!name) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');

        const today = new Date().toISOString().split('T')[0];
        const nowIso = new Date().toLocaleString("sv-SE").replace(" ", "T");

        const { data: existingLogs } = await _supabase.from('attendance')
            .select('*').eq('worker_name', name)
            .gte('check_in', `${today}T00:00:00`).lte('check_in', `${today}T23:59:59`);

        const openLog = existingLogs?.find(log => !log.check_out);

        if (type === 'check_in') {
            if (existingLogs?.length > 0) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„ÙØ¹Ù„ Ø§Ù„ÙŠÙˆÙ…', 'error');
            await _supabase.from('attendance').insert([{ worker_name: name, nid: select.options[select.selectedIndex].dataset.nid, check_in: nowIso, status: 'Ø­Ø§Ø¶Ø±' }]);
            Swal.fire('ØªÙ…', 'Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
            if (!existingLogs?.length) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø¹Ø§Ù…Ù„ Ù„Ù… ÙŠØ­Ø¶Ø± Ø§Ù„ÙŠÙˆÙ…', 'error');
            if (!openLog) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø³Ø¬Ù„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning');
            await _supabase.from('attendance').update({ check_out: nowIso }).eq('id', openLog.id);
            Swal.fire('ØªÙ…', 'Ø³Ø¬Ù„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨Ù†Ø¬Ø§Ø­', 'info');
        }
        fetchLogs();
    }

    async function fetchLogs() {
        const { data } = await _supabase.from('attendance')
            .select('*')
            .order('check_in', { ascending: false })
            .limit(100);
        
        const tbody = document.getElementById('attendanceLogs');
        tbody.innerHTML = '';
        let lastDate = "";

        if (data) {
            data.forEach(log => {
                const currentDate = new Date(log.check_in).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                if (currentDate !== lastDate) {
                    const sep = document.createElement('tr');
                    sep.innerHTML = `<td colspan="4" class="date-separator">Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€  ğŸ“… ${currentDate}  Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€</td>`;
                    tbody.appendChild(sep);
                    lastDate = currentDate;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align:right; padding-right:40px;">${log.worker_name}</td>
                    <td style="color:#059669">${formatTime(log.check_in)}</td>
                    <td style="color:#dc2626">${formatTime(log.check_out)}</td>
                    <td><button class="edit-btn" onclick="editTime(${log.id}, '${log.check_in}', '${log.check_out || ''}')">âœï¸</button></td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    function formatTime(iso) {
        if (!iso) return '-';
        return new Date(iso).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙØµÙ„Ø­Ø© ÙˆØ§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    window.editTime = async (id, currentIn, currentOut) => {
        const formatInput = (iso) => iso ? iso.substring(0, 16) : "";

        const { value: formValues } = await Swal.fire({
            title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„',
            html: `
                <div style="text-align:right; font-weight:bold; margin-bottom:5px;">ÙˆÙ‚Øª Ø§Ù„Ø­Ø¶ÙˆØ±:</div>
                <input id="ei" type="datetime-local" class="swal2-input" value="${formatInput(currentIn)}">
                <div style="text-align:right; font-weight:bold; margin-top:15px; margin-bottom:5px;">ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù:</div>
                <input id="eo" type="datetime-local" class="swal2-input" value="${formatInput(currentOut)}">
            `,
            showCancelButton: true,
            confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            preConfirm: () => {
                return {
                    newIn: document.getElementById('ei').value,
                    newOut: document.getElementById('eo').value
                }
            }
        });

        if (formValues) {
            Swal.showLoading();
            const { error } = await _supabase
                .from('attendance')
                .update({ 
                    check_in: formValues.newIn, 
                    check_out: formValues.newOut || null 
                })
                .eq('id', id);

            if (error) {
                console.error("Error updating:", error);
                Swal.fire('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ' + error.message, 'error');
            } else {
                Swal.fire('ØªÙ…!', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                fetchLogs();
            }
        }
    }

    function filterAttendanceTable() {
        const val = document.getElementById('workerSearchInput').value.toLowerCase();
        document.querySelectorAll('#attendanceLogs tr:not(.date-separator)').forEach(row => {
            row.style.display = row.cells[0].innerText.toLowerCase().includes(val) ? "" : "none";
        });
    }

    function resetToToday() {
        document.getElementById('historyDate').valueAsDate = new Date();
        fetchLogs();
    }

    loadWorkers();
    fetchLogs();
</script>
</body>
</html>
